<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resting Koala System</title>
    
    <!-- LIBRARY -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Quicksand', sans-serif; background-color: #ecfdf5; }
        .koala-gradient { background: linear-gradient(135deg, #10b981 0%, #047857 100%); }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 20px 40px -10px rgba(6, 78, 59, 0.15);
        }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // KONFIGURASI PENTING
        // ==========================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxO3BH_j-Tb_cvDHYY8wCS0aW-T2BAadnjbzNCZ-0ZEhwTLrwf9FUgfUtQdt8edpYqG/exec"; 
        // ==========================================

        const { useState, useEffect } = React;

        function App() {
            // STATE APLIKASI
            const [user, setUser] = useState(null); // null = belum login
            const [view, setView] = useState('login'); // login, absen, dashboard
            
            // STATE DATA
            const [currentTime, setCurrentTime] = useState(new Date());
            const [loginData, setLoginData] = useState({ username: '', password: '' });
            const [status, setStatus] = useState('idle'); 
            const [message, setMessage] = useState('');
            const [dashboardData, setDashboardData] = useState([]);

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            // --- FUNGSI API ---
            const callApi = async (payload) => {
                if (!SCRIPT_URL || SCRIPT_URL.includes("GANTI_DENGAN")) {
                    throw new Error("URL Script belum disetting!");
                }
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                });
                return await response.json();
            };

            // --- HANDLE LOGIN ---
            const handleLogin = async (e) => {
                e.preventDefault();
                setStatus('loading');
                try {
                    const res = await callApi({ 
                        action: 'login', 
                        username: loginData.username, 
                        password: loginData.password 
                    });
                    
                    if (res.result === 'success') {
                        setUser(res.data); // Simpan data user (id, nama, role)
                        setStatus('idle');
                        setMessage('');
                        // Arahkan sesuai Role
                        if (res.data.role === 'HR') {
                            setView('dashboard');
                            fetchDashboard();
                        } else {
                            setView('absen');
                        }
                    } else {
                        setStatus('error');
                        setMessage(res.message);
                    }
                } catch (err) {
                    setStatus('error');
                    setMessage(err.message || 'Gagal Login. Cek Koneksi.');
                }
            };

            // --- HANDLE ABSEN ---
            const handleAbsen = async (type) => {
                setStatus('loading');
                try {
                    const res = await callApi({
                        action: type,
                        id: user.id,   // ID otomatis dari user yang login
                        nama: user.nama
                    });
                    
                    if (res.result === 'success') {
                        setStatus('success');
                        setMessage(res.message);
                    } else {
                        setStatus('error');
                        setMessage(res.message);
                    }
                } catch (err) {
                    setStatus('error');
                    setMessage('Gagal Absen.');
                }
            };

            // --- HANDLE DASHBOARD ---
            const fetchDashboard = async () => {
                try {
                    const res = await callApi({ action: 'get_dashboard' });
                    if(res.result === 'success') setDashboardData(res.data);
                } catch (err) { console.error(err); }
            };

            const handleLogout = () => {
                setUser(null);
                setView('login');
                setLoginData({ username: '', password: '' });
                setMessage('');
                setStatus('idle');
            };

            // --- RENDER HALAMAN LOGIN ---
            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-emerald-50 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                        <div className="glass-card w-full max-w-sm rounded-3xl p-8 relative z-10">
                            <div className="text-center mb-8">
                                <div className="w-16 h-16 bg-emerald-100 rounded-2xl flex items-center justify-center mx-auto mb-4 text-emerald-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2a5 5 0 0 0-5 5v2a5 5 0 0 0 10 0V7a5 5 0 0 0-5-5Z"/><path d="M4 13.5V11a7 7 0 0 1 16 0v2.5"/><path d="M4 16h16"/><path d="M6 16v5h12v-5"/></svg>
                                </div>
                                <h1 className="text-xl font-bold text-slate-800">Resting Koala</h1>
                                <p className="text-emerald-600 text-xs font-bold uppercase">Login Sistem</p>
                            </div>
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-500 ml-1">USERNAME</label>
                                    <input 
                                        type="text" 
                                        value={loginData.username}
                                        onChange={e => setLoginData({...loginData, username: e.target.value})}
                                        className="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-emerald-400 outline-none"
                                        placeholder="Contoh: budi" required
                                    />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 ml-1">PASSWORD</label>
                                    <input 
                                        type="password" 
                                        value={loginData.password}
                                        onChange={e => setLoginData({...loginData, password: e.target.value})}
                                        className="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-emerald-400 outline-none"
                                        placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" required
                                    />
                                </div>
                                {status === 'error' && <div className="text-red-500 text-xs bg-red-50 p-2 rounded text-center">{message}</div>}
                                <button type="submit" disabled={status === 'loading'} className="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-emerald-700 transition-all">
                                    {status === 'loading' ? 'Memuat...' : 'Masuk'}
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            // --- RENDER HALAMAN UTAMA (SETELAH LOGIN) ---
            return (
                <div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden bg-emerald-50">
                    <div className="absolute top-0 left-0 w-full h-64 bg-emerald-600 rounded-b-[3rem] shadow-lg z-0"></div>

                    <div className="glass-card w-full max-w-md rounded-3xl p-6 relative z-10 flex flex-col min-h-[600px]">
                        
                        {/* HEADER USER */}
                        <div className="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                            <div>
                                <h2 className="text-lg font-bold text-slate-800">Halo, {user.nama}</h2>
                                <p className="text-xs text-emerald-600 font-bold uppercase bg-emerald-100 inline-block px-2 py-0.5 rounded">{user.role}</p>
                            </div>
                            <button onClick={handleLogout} className="text-xs text-red-500 font-bold hover:bg-red-50 px-3 py-2 rounded-lg transition">
                                Logout
                            </button>
                        </div>

                        {/* KONTEN KARYAWAN: ABSEN */}
                        {user.role !== 'HR' && view === 'absen' && (
                            <div className="flex-1 flex flex-col">
                                <div className="koala-gradient rounded-2xl p-6 text-white text-center mb-6 shadow-md">
                                    <h2 className="text-4xl font-bold tracking-wide font-mono">
                                        {currentTime.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}
                                    </h2>
                                    <p className="text-xs opacity-90 mt-1">
                                        {currentTime.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                                    </p>
                                </div>

                                {status === 'success' ? (
                                    <div className="text-center py-10 bg-emerald-50 rounded-xl border border-emerald-100">
                                        <div className="text-4xl mb-2">ðŸŽ‰</div>
                                        <h3 className="text-lg font-bold text-slate-800">Berhasil!</h3>
                                        <p className="text-slate-600 text-sm px-4">{message}</p>
                                        <button onClick={() => setStatus('idle')} className="mt-6 text-emerald-600 font-bold text-sm hover:underline">Kembali</button>
                                    </div>
                                ) : (
                                    <div className="space-y-4 mt-4">
                                        {status === 'error' && <div className="text-red-500 text-xs text-center bg-red-50 p-2 rounded-lg">{message}</div>}
                                        
                                        <div className="grid grid-cols-1 gap-4">
                                            <button 
                                                onClick={() => handleAbsen('masuk')}
                                                disabled={status === 'loading'}
                                                className="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-4 rounded-xl shadow-md active:scale-95 transition-all flex items-center justify-center gap-2"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                                                ABSEN MASUK
                                            </button>
                                            <button 
                                                onClick={() => handleAbsen('pulang')}
                                                disabled={status === 'loading'}
                                                className="bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-xl shadow-md active:scale-95 transition-all flex items-center justify-center gap-2"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                                                ABSEN PULANG
                                            </button>
                                        </div>
                                        <p className="text-center text-xs text-slate-400 mt-4">Pastikan Anda berada di lokasi kantor.</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* KONTEN HR: DASHBOARD */}
                        {user.role === 'HR' && view === 'dashboard' && (
                            <div className="flex-1 flex flex-col h-full overflow-hidden">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-slate-700">Data Absensi Hari Ini</h3>
                                    <button onClick={fetchDashboard} className="text-xs text-emerald-600 hover:underline">Refresh</button>
                                </div>

                                <div className="grid grid-cols-2 gap-3 mb-4">
                                    <div className="bg-emerald-50 p-3 rounded-xl border border-emerald-100 text-center">
                                        <p className="text-xs text-slate-500 uppercase font-bold">Total Masuk</p>
                                        <p className="text-2xl font-bold text-emerald-600">{dashboardData.length}</p>
                                    </div>
                                    <div className="bg-orange-50 p-3 rounded-xl border border-orange-100 text-center">
                                        <p className="text-xs text-slate-500 uppercase font-bold">Sudah Pulang</p>
                                        <p className="text-2xl font-bold text-orange-600">
                                            {dashboardData.filter(d => d.pulang !== '-').length}
                                        </p>
                                    </div>
                                </div>

                                <div className="bg-white rounded-xl border border-slate-200 flex-1 overflow-hidden flex flex-col shadow-sm">
                                    <div className="bg-slate-50 px-4 py-2 border-b border-slate-100 flex text-xs font-bold text-slate-500 uppercase">
                                        <div className="flex-1">Nama</div>
                                        <div className="w-16 text-center">Masuk</div>
                                        <div className="w-16 text-center">Pulang</div>
                                    </div>
                                    <div className="overflow-y-auto custom-scroll p-0 flex-1">
                                        {dashboardData.length === 0 ? (
                                            <div className="text-center py-10 text-slate-400 text-sm">Belum ada data.</div>
                                        ) : (
                                            dashboardData.map((item, idx) => (
                                                <div key={idx} className="flex px-4 py-3 border-b border-slate-50 text-sm hover:bg-slate-50 transition-colors">
                                                    <div className="flex-1 font-medium text-slate-700 truncate">{item.nama}</div>
                                                    <div className="w-16 text-center text-emerald-600 bg-emerald-50 rounded-md py-0.5 mx-1 text-xs font-bold">{item.masuk}</div>
                                                    <div className={`w-16 text-center rounded-md py-0.5 mx-1 text-xs font-bold ${item.pulang !== '-' ? 'text-orange-600 bg-orange-50' : 'text-slate-300'}`}>{item.pulang}</div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* PESAN ERROR JIKA KARYAWAN COBA AKSES DASHBOARD (Just in case) */}
                        {user.role !== 'HR' && user.role !== 'Karyawan' && (
                            <div className="text-center text-red-500 mt-10">Role Tidak Dikenali</div>
                        )}

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
